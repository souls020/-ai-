"""Prompt 模板: {{ name }}

功能: 可复用的 Prompt 模板，支持变量替换和 LLM 调用
使用: python {{ name }}_prompt.py
"""

import json
import urllib.request
import urllib.error
from string import Template
from typing import Optional


{% if docstring_style == "google" %}
def {{ name }}(template: str = None, **kwargs) -> str:
    """渲染 Prompt 模板。

    Args:
        template: 自定义模板内容（默认使用内置模板）
        **kwargs: 模板变量的键值对

    Returns:
        渲染后的 Prompt 字符串

    示例:
        >>> {{ name }}(name="小明", role="翻译官")
    """
{% elif docstring_style == "numpy" %}
def {{ name }}(template: str = None, **kwargs) -> str:
    """渲染 Prompt 模板。

    Parameters
    ----------
    template : str, optional
        自定义模板内容（默认使用内置模板）
    **kwargs
        模板变量的键值对

    Returns
    -------
    str
        渲染后的 Prompt 字符串

    示例
    ----
    >>> {{ name }}(name="小明", role="翻译官")
    """
{% else %}
def {{ name }}(template: str = None, **kwargs) -> str:
    """渲染 Prompt 模板。

    参数:
        template: 自定义模板内容（默认使用内置模板）
        **kwargs: 模板变量的键值对

    返回:
        渲染后的 Prompt 字符串
    """
{% endif %}
{% if comment_style == "full" %}
    # 使用 Python 内置 Template，支持 $变量 和 ${变量} 语法
{% endif %}
    if template is None:
        template = DEFAULT_TEMPLATE
    t = Template(template)
    return t.safe_substitute(**kwargs)


def call_llm(
    prompt: str,
    api_key: str = "",
    base_url: str = "https://api.openai.com/v1",
    model: str = "gpt-3.5-turbo",
) -> str:
{% if docstring_style == "google" %}
    """将 Prompt 发送给 LLM 并获取回复。

    Args:
        prompt: 完整的 Prompt 文本
        api_key: API 密钥
        base_url: API 地址
        model: 模型名称

    Returns:
        LLM 的回复
    """
{% else %}
    """将 Prompt 发送给 LLM 并获取回复。

    参数:
        prompt: 完整的 Prompt 文本
        api_key: API 密钥
        base_url: API 地址
        model: 模型名称

    返回:
        LLM 的回复
    """
{% endif %}
    url = f"{base_url.rstrip('/')}/chat/completions"
    payload = {
        "model": model,
        "messages": [{"role": "user", "content": prompt}],
        "temperature": 0.7,
    }
    data = json.dumps(payload).encode("utf-8")
    headers = {"Content-Type": "application/json"}
    if api_key:
        headers["Authorization"] = f"Bearer {api_key}"

    req = urllib.request.Request(url, data=data, headers=headers, method="POST")
    with urllib.request.urlopen(req, timeout=60) as resp:
        result = json.loads(resp.read().decode("utf-8"))
        return result["choices"][0]["message"]["content"]


{% if comment_style == "full" %}
# 默认 Prompt 模板 - 可根据需要修改
{% endif %}
DEFAULT_TEMPLATE = """{{ template_content }}"""


if __name__ == "__main__":
    import os

{% if comment_style == "full" %}
    # 渲染模板
{% endif %}
    prompt = {{ name }}()
    print("渲染后的 Prompt:")
    print(prompt)
    print()

{% if comment_style == "full" %}
    # 如果设置了 API Key，直接调用 LLM
{% endif %}
    api_key = os.environ.get("LLM_API_KEY", "")
    if api_key:
        print("正在调用 LLM...")
        reply = call_llm(
            prompt,
            api_key=api_key,
            base_url=os.environ.get("LLM_BASE_URL", "https://api.openai.com/v1"),
            model=os.environ.get("LLM_MODEL", "gpt-3.5-turbo"),
        )
        print(f"LLM 回复: {reply}")
    else:
        print("提示: 设置环境变量 LLM_API_KEY 后可直接调用 LLM")
