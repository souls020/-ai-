"""{{ class_name }}

åŠŸèƒ½: {{ description }}
ä½¿ç”¨: python {{ name }}.py
"""

import json
import urllib.request
import urllib.error
from typing import Any, Dict, List, Optional


class {{ class_name }}:
{% if docstring_style == "google" %}
    """{{ description }}

    Attributes:
        name: Agent åç§°
        model: ä½¿ç”¨çš„ LLM æ¨¡å‹
        history: å¯¹è¯å†å²
    """
{% elif docstring_style == "numpy" %}
    """{{ description }}

    Attributes
    ----------
    name : str
        Agent åç§°
    model : str
        ä½¿ç”¨çš„ LLM æ¨¡å‹
    history : list
        å¯¹è¯å†å²
    """
{% else %}
    """{{ description }}

    å±æ€§:
        name: Agent åç§°
        model: ä½¿ç”¨çš„ LLM æ¨¡å‹
        history: å¯¹è¯å†å²
    """
{% endif %}

    def __init__(
        self,
        api_key: str = "",
        base_url: str = "https://api.openai.com/v1",
        model: str = "gpt-3.5-turbo",
        system_prompt: str = "",
    ):
{% if docstring_style == "google" %}
        """åˆå§‹åŒ– Agentã€‚

        Args:
            api_key: LLM API å¯†é’¥
            base_url: API åœ°å€ï¼ˆæ”¯æŒ OpenAI å…¼å®¹æ¥å£ï¼‰
            model: æ¨¡å‹åç§°
            system_prompt: ç³»ç»Ÿæç¤ºè¯
        """
{% elif docstring_style == "numpy" %}
        """åˆå§‹åŒ– Agentã€‚

        Parameters
        ----------
        api_key : str
            LLM API å¯†é’¥
        base_url : str
            API åœ°å€ï¼ˆæ”¯æŒ OpenAI å…¼å®¹æ¥å£ï¼‰
        model : str
            æ¨¡å‹åç§°
        system_prompt : str
            ç³»ç»Ÿæç¤ºè¯
        """
{% else %}
        """åˆå§‹åŒ– Agentã€‚

        å‚æ•°:
            api_key: LLM API å¯†é’¥
            base_url: API åœ°å€ï¼ˆæ”¯æŒ OpenAI å…¼å®¹æ¥å£ï¼‰
            model: æ¨¡å‹åç§°
            system_prompt: ç³»ç»Ÿæç¤ºè¯
        """
{% endif %}
        self.name = "{{ name }}"
        self.description = "{{ description }}"
        self.api_key = api_key
        self.base_url = base_url.rstrip("/")
        self.model = model
        self.system_prompt = system_prompt or "{{ description }}"
        self.history: List[Dict[str, str]] = [
            {"role": "system", "content": self.system_prompt}
        ]

{% if comment_style == "full" %}
    # è°ƒç”¨ LLM Chat Completions API
{% endif %}
    def _call_api(self, messages: List[Dict[str, str]], stream: bool = False) -> dict:
        """è°ƒç”¨ Chat Completions API"""
        url = f"{self.base_url}/chat/completions"
        payload = {
            "model": self.model,
            "messages": messages,
            "temperature": 0.7,
            "max_tokens": 2048,
            "stream": stream,
        }
        data = json.dumps(payload).encode("utf-8")
        headers = {"Content-Type": "application/json"}
        if self.api_key:
            headers["Authorization"] = f"Bearer {self.api_key}"

        req = urllib.request.Request(url, data=data, headers=headers, method="POST")
        try:
            with urllib.request.urlopen(req, timeout=120) as resp:
                if stream:
                    return self._read_stream(resp)
                return json.loads(resp.read().decode("utf-8"))
        except urllib.error.HTTPError as e:
            body = e.read().decode("utf-8", errors="replace")
            raise RuntimeError(f"API é”™è¯¯ (HTTP {e.code}): {body}") from e
        except urllib.error.URLError as e:
            raise RuntimeError(f"æ— æ³•è¿æ¥ API: {e.reason}") from e

    def _read_stream(self, resp) -> dict:
        """å¤„ç†æµå¼å“åº”"""
        content = ""
        for line in resp:
            line = line.decode("utf-8").strip()
            if not line or not line.startswith("data: "):
                continue
            if line[6:] == "[DONE]":
                break
            try:
                chunk = json.loads(line[6:])
                delta = chunk["choices"][0].get("delta", {}).get("content", "")
                if delta:
                    print(delta, end="", flush=True)
                    content += delta
            except (json.JSONDecodeError, KeyError, IndexError):
                continue
        print()
        return {"choices": [{"message": {"role": "assistant", "content": content}}]}

{% if comment_style == "full" %}
    # å‘é€æ¶ˆæ¯å¹¶è·å– LLM å›å¤
{% endif %}
    def run(self, user_input: str, stream: bool = True) -> str:
{% if docstring_style == "google" %}
        """è¿è¡Œ Agent å¤„ç†ç”¨æˆ·è¾“å…¥ã€‚

        Args:
            user_input: ç”¨æˆ·è¾“å…¥
            stream: æ˜¯å¦æµå¼è¾“å‡º

        Returns:
            LLM çš„å›å¤
        """
{% else %}
        """è¿è¡Œ Agent å¤„ç†ç”¨æˆ·è¾“å…¥ã€‚

        å‚æ•°:
            user_input: ç”¨æˆ·è¾“å…¥
            stream: æ˜¯å¦æµå¼è¾“å‡º

        è¿”å›:
            LLM çš„å›å¤
        """
{% endif %}
        self.history.append({"role": "user", "content": user_input})
        result = self._call_api(self.history, stream=stream)
        reply = result["choices"][0]["message"]["content"]
        self.history.append({"role": "assistant", "content": reply})
        return reply

    def clear_history(self):
        """æ¸…ç©ºå¯¹è¯å†å²"""
        self.history = [{"role": "system", "content": self.system_prompt}]


{% if comment_style == "full" %}
# ä½¿ç”¨ç¤ºä¾‹ - è¯·å…ˆè®¾ç½®ä½ çš„ API Key å’Œ Base URL
{% endif %}
if __name__ == "__main__":
    import os

    agent = {{ class_name }}(
        api_key=os.environ.get("LLM_API_KEY", ""),
        base_url=os.environ.get("LLM_BASE_URL", "https://api.openai.com/v1"),
        model=os.environ.get("LLM_MODEL", "gpt-3.5-turbo"),
    )

    print(f"ğŸ¤– {agent.name} å·²å¯åŠ¨ (æ¨¡å‹: {agent.model})")
    print("   è¾“å…¥ /exit é€€å‡º\n")

    while True:
        try:
            user_input = input("ä½  > ")
        except (EOFError, KeyboardInterrupt):
            print("\nğŸ‘‹ å†è§ï¼")
            break
        if not user_input.strip():
            continue
        if user_input.strip() in ("/exit", "/quit"):
            print("ğŸ‘‹ å†è§ï¼")
            break
        print(f"\n{agent.name} > ", end="")
        try:
            agent.run(user_input, stream=True)
        except RuntimeError as e:
            print(f"\nâŒ {e}")
        print()
